generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String?   @unique
  password      String
  name          String    // Legal Name
  displayName   String?
  role          String      @default("PARTNER")
  accountStatus String      @default("ACTIVE") // ACTIVE / INACTIVE / SUSPENDED
  twoFactorEnabled Boolean  @default(false)
  loginStartDate DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  partnerProfile Partner?
  auditLogs     AuditLog[]
  completedTasks Task[]    @relation("TaskCompletion")
  taskComments  TaskComment[]
  documents     ProjectDocument[]
}

model Partner {
  id              String         @id @default(cuid())
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id])
  
  // 1. Identity & Contact
  phoneNumber     String?
  emergencyContact String?
  address         String?
  city            String?
  country         String?
  timezone        String?        @default("UTC")
  
  // 3. Role Configuration
  partnerType     String         @default("NON_EQUITY") // EQUITY / NON_EQUITY / CONTRACTOR
  isEquity        Boolean        @default(false)
  hasVotingRights Boolean        @default(false)
  canApprovePayouts Boolean      @default(false)
  canFinalizeContribution Boolean @default(false)
  canEditFinancials Boolean      @default(false)
  canCreateProjects Boolean      @default(false)
  
  // 4. Equity & Profit Structure
  equityPercentage Float         @default(0)
  isBaseShareEligible Boolean    @default(true)
  baseShareDecayEnabled Boolean  @default(false)
  isIncludedInPerformancePool Boolean @default(true)
  isIncludedInBasePool Boolean    @default(true)
  defaultContributionWeight Float @default(1)
  
  // 5. Financial & Payout Details
  totalCapitalContributed Float  @default(0)
  bankAccountName  String?
  bankAccountNumber String?
  ifscSwift        String?
  upiId            String?
  payoutMethod     String?       @default("BANK_TRANSFER")
  taxIdPan         String?
  currency         String        @default("INR")
  hasRevenueVisibility Boolean   @default(false)
  
  // 6. Responsibility Assignment
  defaultProjectRole String?     // TECHNICAL / SALES / MANAGEMENT
  canLeadProjects    Boolean     @default(false)
  canHandleClientComms Boolean   @default(false)
  canApproveScope     Boolean    @default(false)
  
  // 7. Contribution Tracking Permissions
  canLogTasks        Boolean     @default(true)
  canEditOwnLogs     Boolean     @default(true)
  canEditOthersLogs  Boolean     @default(false)
  canViewContributionBreakdown Boolean @default(true)
  canOverrideContribution Boolean @default(false) // Admin override
  
  // 8. Agreement Acceptance
  agreementAccepted  Boolean     @default(false)
  digitalSignature   String?
  dateAccepted       DateTime?
  agreementVersionId String?
  
  // 9. Activity & Status
  joinDate           DateTime    @default(now())
  lastActiveDate     DateTime?
  performanceTrackingEnabled Boolean @default(true)
  baseShareEligibilityStartDate DateTime @default(now())

  totalEarnings   Float          @default(0)
  payouts         Payout[]
  contributions   Contribution[]
  capitalInjections CapitalInjection[]
  tasks           Task[]
}

model Project {
  id                String         @id @default(cuid())
  name              String
  clientName        String
  totalValue        Float
  netProfit         Float?         // Calculated: Total - Reserves
  startDate         DateTime
  endDate           DateTime?
  status            String         @default("ACTIVE") // Planned / Active / On Hold / Completed / Cancelled
  description       String?
  
  // Core Identification
  projectIdCustom   String?        @unique // Auto-generated ID (Optional display)
  projectType       String?        // VAPT / Development / Consulting / Mixed
  category          String?        // e.g., Web App VAPT
  priority          String?        @default("MEDIUM") // Low / Medium / High / Critical
  
  // Client & Engagement Details
  clientContact     String?
  clientEmail       String?
  clientPhone       String?
  whatsappNumber    String?
  commsChannel      String?        // Email / WhatsApp / Slack
  timezone          String?
  location          String?
  ndaSigned         Boolean        @default(false)
  ndaFile           String?        // Path to uploaded NDA
  contractFile      String?        // Path to uploaded contract
  
  // Timeline & Scheduling
  internalDeadline  DateTime?
  clientDeadline    DateTime?
  milestones        Milestone[]
  
  // Scope & Requirements
  objectives        String?
  deliverables      String?        // JSON string or long text
  outOfScope        String?
  techStack         String?        // Tools/technologies involved
  environments      String?        // Prod / Staging / Dev
  accessReqs        String?        // VPN, credentials, etc.
  dependencies      String?        // third-party access, client inputs
  riskLevel         String?        @default("LOW")
  
  // External Integrations
  githubUrl         String?        // GitHub Repository URL
  
  // Team Assignment (Lead IDs)
  projectLeadId     String?
  techLeadId        String?
  commsLeadId       String?
  qaLeadId          String?
  salesOwnerId      String?
  
  // Contribution & Task Setup
  enableContributionTracking Boolean @default(true)
  weights           String         // Storing category weights as JSON string
  lockWeights       Boolean        @default(false)
  enableTaskLogging Boolean        @default(true)
  effortScale       String?        @default("FIBONACCI") // 1/3/5/8
  timeTrackingEnabled Boolean      @default(false)
  approvalRequired  Boolean        @default(false)
  
  // Project Management Controls
  visibility        String         @default("INTERNAL") // Private / Internal / All
  canEdit           String?        // Roles or IDs
  canAddTasks       String?
  canFinalize       String?
  autoLock          Boolean        @default(true)
  
  // Notes & Risk Tracking
  specialInstructions String?
  riskNotes         String?
  clientConstraints String?
  escalationContact String?
  internalRemarks   String?

  tasks             Task[]
  contributions     Contribution[]
  financialRecords  Financial[]
  transactions      Transaction[]
  payouts           Payout[]
  documents         ProjectDocument[]
  isLocked          Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model ProjectDocument {
  id           String   @id @default(cuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id])
  name         String   // Display name
  fileKey      String   // Unique filename on disk
  mimeType     String
  size         Int
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())
}

model Transaction {
  id            String   @id @default(cuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
  amount        Float
  date          DateTime @default(now())
  type          String   // INCOME / EXPENSE
  category      String?  // BUSINESS_GROWTH / RELIGIOUS / CHARITY / OTHER / GENERAL
  method        String   // UPI / Card / Bank / Cash / Other
  transactionId String?  // Optional reference number
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Milestone {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  name        String
  dueDate     DateTime
  deliverables String?
  status      String   @default("PLANNED")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Task {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id])
  name            String
  category        String
  effortWeight    Float     @default(1)
  assignedPartnerId String?
  assignedPartner   Partner?  @relation(fields: [assignedPartnerId], references: [id])
  timeSpent       Float     @default(0)
  completionPercent Float   @default(0)
  status          String    @default("BACKLOG") // BACKLOG / IN_PROGRESS / REVIEW / DONE
  
  completedById   String?
  completedBy     User?     @relation("TaskCompletion", fields: [completedById], references: [id])
  completedAt     DateTime?

  comments        TaskComment[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  type      String   @default("COMMENT") // COMMENT / REVIEW
  createdAt DateTime @default(now())
}

model Contribution {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id])
  percentage  Float    // Calculated live
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([projectId, partnerId])
}

model Financial {
  id                  String   @id @default(cuid())
  projectId           String
  project             Project  @relation(fields: [projectId], references: [id])
  businessReserve     Float    // 10%
  religiousAllocation Float    // 5%
  netDistributable    Float
  basePool            Float    // 20% of net
  performancePool     Float    // 80% of net
  createdAt           DateTime @default(now())
}

model Payout {
  id                String   @id @default(cuid())
  projectId         String
  project           Project  @relation(fields: [projectId], references: [id])
  partnerId         String
  partner           Partner  @relation(fields: [partnerId], references: [id])
  baseShare         Float
  performanceShare  Float
  totalPayout       Float
  isApproved        Boolean  @default(false)
  payoutDate        DateTime?
  createdAt         DateTime @default(now())
}

model AgreementVersion {
  id          String   @id @default(cuid())
  content     String
  version     Int      @default(1)
  isCurrent   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?
  details   String?
  createdAt DateTime @default(now())
}

model Invitation {
  id              String   @id @default(cuid())
  email           String
  name            String
  role            String   @default("PARTNER")
  token           String   @unique
  expiresAt       DateTime
  status          String   @default("PENDING") // PENDING / ACCEPTED / EXPIRED
  
  // Pre-configured data from admin
  partnerType     String   @default("NON_EQUITY")
  isEquity        Boolean  @default(false)
  equityPercentage Float   @default(0)
  
  invitedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
model SystemSetting {
  id                String   @id @default("SYSTEM")
  companyName       String   @default("Strategic Cyber Security")
  companyAddress    String?
  companyDescription String?
  companyLogo       String?  // Logo URL or Base64
  companyEmail      String?
  companyPhone      String?
  companyWebsite    String?
  companyTaxId      String?
  bankName          String?
  bankAccountName   String?
  bankAccountNumber String?
  bankIfsc          String?
  bankSwift         String?
  updatedAt         DateTime @updatedAt
}

model CapitalInjection {
  id          String   @id @default(cuid())
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id])
  amount      Float
  date        DateTime @default(now())
  equityDelta Float    // Change in equity percentage (e.g., +5.0)
  postEquity  Float    // Equity snapshot after update
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
